import React, { createContext, useState, useContext, ReactNode, useEffect } from 'react';

type Language = 'en' | 'zh';

const translations = {
  en: {
    // Menu
    'menu.dashboard': 'Dashboard',
    'menu.reports': 'WDR Reports',
    'menu.comparison': 'Comparison',
    'menu.visualizer': 'Plan Visualizer',
    'menu.thresholds': 'Thresholds',
    'menu.sqlaudit': 'SQL Audit',
    'menu.auditlog': 'Audit Logs',
    
    // Header
    'header.role': 'DBA Admin',
    
    // Dashboard
    'dash.cpu': 'CPU Usage',
    'dash.mem': 'Memory Usage',
    'dash.tps': 'TPS',
    'dash.qps': 'QPS',
    'dash.health': 'Instance Health',
    'dash.trend': 'Top Issue Trend (Today)',
    'dash.hotIssues': 'Top 10 Hot Issues',
    'dash.recentReports': 'Recent WDR Reports',
    'dash.view': 'View',
    'dash.details': 'Details',
    'dash.healthy': 'Healthy',
    'dash.warning': 'Warning',
    'dash.critical': 'Critical',
    'dash.instanceOverview': 'Instance Overview',
    'dash.selectInstance': 'Select Instance',
    'dash.allInstances': 'All Instances',
    'dash.lastReport': 'Last Report',
    'dash.activeIssues': 'Active Issues',
    'dash.score': 'Health Score',

    // Reports
    'rep.search': 'Search Instance...',
    'rep.upload': 'Upload Report',
    'rep.id': 'ID',
    'rep.instance': 'Instance',
    'rep.generated': 'Generated At',
    'rep.period': 'Period',
    'rep.status': 'Status',
    'rep.actions': 'Actions',
    'rep.loading': 'Loading...',
    'rep.uploadTitle': 'Upload WDR Report',
    'rep.instanceName': 'Instance Name',
    'rep.desc': 'Description (Optional)',
    'rep.file': 'Report File',
    'rep.clickUpload': 'Click to upload or drag and drop',
    'rep.fileHint': 'HTML or WDR files up to 50MB',
    'rep.cancel': 'Cancel',
    'rep.submit': 'Upload Report',
    'rep.showing': 'Showing {start}-{end} of {total}',
    'rep.prev': 'Prev',
    'rep.next': 'Next',
    'rep.deleteTitle': 'Delete Report',
    'rep.deleteConfirm': 'Are you sure you want to delete report #{id}? This action cannot be undone.',
    'rep.delete': 'Delete',
    'rep.viewTitle': 'Report Details',
    'rep.tab.summary': 'Overview',
    'rep.tab.load': 'Load Profile',
    'rep.tab.sqlstats': 'SQL Statistics',
    'rep.tab.objstats': 'Object Statistics',
    'rep.summary.efficiency': 'Instance Efficiency',
    'rep.summary.workload': 'Workload Profile (Per Second)',
    'rep.summary.db': 'Database Statistics',
    'rep.metric': 'Metric',
    'rep.perSec': 'Per Second',
    'rep.perTxn': 'Per Transaction',
    'rep.sql.orderBy': 'Order By',
    'rep.sql.elapsed': 'Elapsed Time',
    'rep.sql.cpu': 'CPU Time',
    'rep.sql.calls': 'Executions',
    'rep.sql.reads': 'Physical Reads',
    'rep.sql.text': 'Full SQL Text',
    'rep.sql.visualize': 'Visualize Plan',
    'rep.obj.table': 'Tables',
    'rep.obj.index': 'Indexes',
    'rep.obj.deadTup': 'Dead Tuples',
    'rep.obj.liveTup': 'Live Tuples',
    'rep.obj.seqScan': 'Seq Scan',
    'rep.obj.idxScan': 'Idx Scan',

    // Comparison
    'comp.selected': 'Selected Reports',
    'comp.new': 'New Comparison',
    'comp.name': 'Comparison Name',
    'comp.desc': 'Description',
    'comp.save': 'Save',
    'comp.tab.sql': 'SQL Statistics',
    'comp.tab.wait': 'Wait Events',
    'comp.tab.obj': 'Object Stats',
    'comp.tab.sys': 'System Metrics',
    'comp.fingerprint': 'SQL Fingerprint',
    'comp.r1': 'Report 1',
    'comp.r2': 'Report 2',
    'comp.change': 'Change',
    'comp.plan': 'Plan',
    'comp.action': 'Action',
    'comp.col.event': 'Event Name',
    'comp.col.class': 'Class',
    'comp.col.time': 'Time (ms)',
    'comp.col.object': 'Object Name',
    'comp.col.schema': 'Schema',
    'comp.col.scans': 'Scans',
    'comp.col.metric': 'Metric Name',
    'comp.col.val': 'Value',
    'comp.col.diff': 'Diff',
    'comp.col.cpu': 'CPU Time',
    'comp.col.io': 'IO Time',
    'comp.col.seq': 'Seq Scan',
    'comp.col.idx': 'Idx Scan',
    'comp.col.tup': 'Tuples (I/U/D)',
    'comp.overview.title': 'Metric Comparison Overview',
    'comp.chart.dbTime': 'DB Time (s)',
    'comp.chart.cpu': 'CPU Usage (%)',
    'comp.chart.io': 'IOPS',
    'comp.col.phyRd': 'Phy Reads',
    'comp.col.logRd': 'Log Reads',
    'comp.col.heapRd': 'Heap Read',
    'comp.col.heapHit': 'Heap Hit',
    'comp.col.idxRd': 'Idx Read',
    'comp.col.idxHit': 'Idx Hit',
    
    // Comparison Summary
    'comp.summary.title': 'Analysis Summary',
    'comp.summary.conclusion': 'Conclusion',
    'comp.summary.findings': 'Key Findings',
    'comp.summary.score': 'Performance Score',
    'comp.status.improved': 'Improved',
    'comp.status.degraded': 'Degraded',
    'comp.status.stable': 'Stable',

    // Thresholds
    'thr.categories': 'Categories',
    'thr.config': 'Configuration',
    'thr.batchSave': 'Batch Save',
    'thr.templates': 'Templates',
    'thr.sysTemplates': 'System Templates',
    'thr.customTemplates': 'Custom Templates',
    'thr.key': 'Key',
    'thr.value': 'Value',
    'thr.unit': 'Unit',
    'thr.range': 'Range',
    'thr.action': 'Action',

    // SQL Audit
    'audit.all': 'All',
    'audit.pending': 'Pending',
    'audit.processing': 'Processing',
    'audit.fixed': 'Fixed',
    'audit.whitelisted': 'Whitelisted',
    'audit.id': 'ID',
    'audit.severity': 'Severity',
    'audit.type': 'Type',
    'audit.target': 'Target',
    'audit.foundTime': 'Found Time',
    'audit.status': 'Status',
    'audit.actions': 'Actions',
    'audit.optimize': 'Optimize',
    'audit.modalTitle': 'SQL Optimization',
    'audit.issueId': 'Issue ID',
    'audit.targetSql': 'Target SQL',
    'audit.diagnosis': 'Diagnosis',
    'audit.recommendation': 'Recommendation',
    'audit.apply': 'Apply Fix',
    'audit.whitelist': 'Whitelist',
    'audit.cancel': 'Cancel',

    // Audit Log
    'log.allOps': 'All Operations',
    'log.updateThr': 'Update Threshold',
    'log.export': 'Export',
    'log.time': 'Time',
    'log.user': 'User',
    'log.op': 'Operation',
    'log.target': 'Target',
    'log.result': 'Result',
    
    // Visualizer
    'vis.title': 'Execution Plan Visualizer',
    'vis.import': 'Import',
    'vis.view': 'View',
    'vis.costThreshold': 'Cost Threshold',
    'vis.explain': 'Explain',
    'vis.help': 'Guide',
    'vis.sqlEditor': 'SQL Editor',
    'vis.syntax': 'GaussDB Syntax',
    'vis.pastePlaceholder': 'Paste your SQL here...',
    'vis.planText': 'Plan Text',
    'vis.rawExplain': 'Raw Explain',
    'vis.noPlan': 'No plan generated',
    'vis.visualTree': 'Visual Tree',
    'vis.totalCost': 'Total Cost',
    'vis.analyzing': 'Analyzing Execution Plan...',
    'vis.selectSql': 'Select a SQL to visualize plan',
    'vis.node.cost': 'Cost',
    'vis.node.rows': 'Rows',
    'vis.node.width': 'Width',
    'vis.node.target': 'Target Object',
    'vis.node.details': 'Details',
    'vis.opt.suggestions': 'Optimization Suggestions',
    'vis.opt.highCost': 'High Cost Join Detected',
    'vis.opt.highCostDesc': 'The Hash Join at the root has a cost of {cost}, which exceeds the threshold. Consider checking if the join columns are indexed.',
    'vis.opt.indexOpp': 'Index Opportunity',
    'vis.opt.indexOppDesc': 'Seq Scan on \'users\' with filter. Consider creating an index.',
    'vis.opt.loadToSee': 'Load a plan to see suggestions',
    'vis.hot.title': 'WDR Hot SQLs',
    'vis.hot.viewFull': 'View Full Report',
    'vis.hot.preview': 'SQL Preview',
    'vis.hot.time': 'Time',
    'vis.hot.cost': 'Cost',
    'vis.hot.action': 'Action',
    'vis.hot.load': 'Load',

    // Visualizer Help Guide
    'vis.guide.title': 'GaussDB Execution Plan Guide',
    'vis.guide.scans': 'Scan Methods',
    'vis.guide.joins': 'Join Methods',
    'vis.guide.others': 'Other Operators',
    'vis.guide.seqScan': 'Seq Scan',
    'vis.guide.seqScanDesc': 'Full table scan. Reads every row in the table. Usually efficient for small tables or when retrieving a large percentage of rows, but slow for large tables with selective filters.',
    'vis.guide.indexScan': 'Index Scan',
    'vis.guide.indexScanDesc': 'Uses an index to find specific rows. Much faster than Seq Scan for selective queries.',
    'vis.guide.bitmapScan': 'Bitmap Heap/Index Scan',
    'vis.guide.bitmapScanDesc': 'Combines multiple index scans or handles too many non-sequential row fetches efficiently.',
    'vis.guide.nestLoop': 'Nested Loop',
    'vis.guide.nestLoopDesc': 'Joins two tables by looping through every row of the outer table and finding matches in the inner table. Efficient when the outer table is small or the inner table is indexed.',
    'vis.guide.hashJoin': 'Hash Join',
    'vis.guide.hashJoinDesc': 'Loads the candidate rows from the "inner" table into a hash table, then scans the "outer" table to probe for matches. Good for large, unsorted datasets.',
    'vis.guide.mergeJoin': 'Merge Join',
    'vis.guide.mergeJoinDesc': 'Joins two sorted datasets. Very efficient if the input data is already sorted (e.g., by an index).',
    'vis.guide.agg': 'Aggregation (Hash/Group)',
    'vis.guide.aggDesc': 'Operations like GROUP BY or DISTINCT. HashAggregate uses a hash table, while GroupAggregate requires sorted input.',
  },
  zh: {
    // Menu
    'menu.dashboard': '仪表盘',
    'menu.reports': 'WDR 报告',
    'menu.comparison': '对比分析',
    'menu.visualizer': '执行计划分析',
    'menu.thresholds': '阈值配置',
    'menu.sqlaudit': 'SQL 审计',
    'menu.auditlog': '审计日志',

    // Header
    'header.role': 'DBA 管理员',

    // Dashboard
    'dash.cpu': 'CPU 使用率',
    'dash.mem': '内存使用率',
    'dash.tps': 'TPS',
    'dash.qps': 'QPS',
    'dash.health': '实例健康度',
    'dash.trend': 'Top 问题趋势 (今日)',
    'dash.hotIssues': 'Top 10 热门问题',
    'dash.recentReports': '近期 WDR 报告',
    'dash.view': '查看',
    'dash.details': '详情',
    'dash.healthy': '健康',
    'dash.warning': '警告',
    'dash.critical': '严重',
    'dash.instanceOverview': '实例概览',
    'dash.selectInstance': '选择实例',
    'dash.allInstances': '所有实例',
    'dash.lastReport': '最新报告',
    'dash.activeIssues': '活跃问题',
    'dash.score': '健康分',

    // Reports
    'rep.search': '搜索实例...',
    'rep.upload': '上传报告',
    'rep.id': 'ID',
    'rep.instance': '实例',
    'rep.generated': '生成时间',
    'rep.period': '时段',
    'rep.status': '状态',
    'rep.actions': '操作',
    'rep.loading': '加载中...',
    'rep.uploadTitle': '上传 WDR 报告',
    'rep.instanceName': '实例名称',
    'rep.desc': '描述 (可选)',
    'rep.file': '报告文件',
    'rep.clickUpload': '点击上传或拖拽文件',
    'rep.fileHint': '支持 HTML 或 WDR 文件，最大 50MB',
    'rep.cancel': '取消',
    'rep.submit': '确认上传',
    'rep.showing': '显示 {start}-{end} 共 {total}',
    'rep.prev': '上一页',
    'rep.next': '下一页',
    'rep.deleteTitle': '删除报告',
    'rep.deleteConfirm': '确定要删除报告 #{id} 吗？此操作无法撤销。',
    'rep.delete': '删除',
    'rep.viewTitle': '报告详情',
    'rep.tab.summary': '摘要',
    'rep.tab.load': '负载概况',
    'rep.tab.sqlstats': 'SQL 统计',
    'rep.tab.objstats': '对象统计',
    'rep.summary.efficiency': '实例效率指标',
    'rep.summary.workload': '负载概况 (每秒)',
    'rep.summary.db': '数据库统计',
    'rep.metric': '指标',
    'rep.perSec': '每秒',
    'rep.perTxn': '每事务',
    'rep.sql.orderBy': '排序方式',
    'rep.sql.elapsed': '执行耗时',
    'rep.sql.cpu': 'CPU 时间',
    'rep.sql.calls': '执行次数',
    'rep.sql.reads': '物理读',
    'rep.sql.text': '完整 SQL',
    'rep.sql.visualize': '可视化计划',
    'rep.obj.table': '表统计',
    'rep.obj.index': '索引统计',
    'rep.obj.deadTup': '死元组',
    'rep.obj.liveTup': '活元组',
    'rep.obj.seqScan': '全表扫描',
    'rep.obj.idxScan': '索引扫描',

    // Comparison
    'comp.selected': '已选报告',
    'comp.new': '新建对比',
    'comp.name': '对比名称',
    'comp.desc': '描述',
    'comp.save': '保存',
    'comp.tab.sql': 'SQL 统计',
    'comp.tab.wait': '等待事件',
    'comp.tab.obj': '对象统计',
    'comp.tab.sys': '系统指标',
    'comp.fingerprint': 'SQL 指纹',
    'comp.r1': '报告 1',
    'comp.r2': '报告 2',
    'comp.change': '变化率',
    'comp.plan': '计划',
    'comp.action': '操作',
    'comp.col.event': '事件名称',
    'comp.col.class': '类别',
    'comp.col.time': '耗时 (ms)',
    'comp.col.object': '对象名称',
    'comp.col.schema': '模式',
    'comp.col.scans': '扫描次数',
    'comp.col.metric': '指标名称',
    'comp.col.val': '数值',
    'comp.col.diff': '差值',
    'comp.col.cpu': 'CPU时间',
    'comp.col.io': 'IO时间',
    'comp.col.seq': '全表扫描',
    'comp.col.idx': '索引扫描',
    'comp.col.tup': '元组(I/U/D)',
    'comp.overview.title': '指标对比概览',
    'comp.chart.dbTime': 'DB Time (秒)',
    'comp.chart.cpu': 'CPU 使用率 (%)',
    'comp.chart.io': 'IOPS',
    'comp.col.phyRd': '物理读',
    'comp.col.logRd': '逻辑读',
    'comp.col.heapRd': '堆读取',
    'comp.col.heapHit': '堆命中',
    'comp.col.idxRd': '索引读取',
    'comp.col.idxHit': '索引命中',

    // Comparison Summary
    'comp.summary.title': '分析摘要',
    'comp.summary.conclusion': '分析结论',
    'comp.summary.findings': '关键发现',
    'comp.summary.score': '性能评分',
    'comp.status.improved': '优化',
    'comp.status.degraded': '退化',
    'comp.status.stable': '稳定',

    // Thresholds
    'thr.categories': '分类',
    'thr.config': '配置',
    'thr.batchSave': '批量保存',
    'thr.templates': '模板',
    'thr.sysTemplates': '系统模板',
    'thr.customTemplates': '自定义模板',
    'thr.key': '键名',
    'thr.value': '阈值',
    'thr.unit': '单位',
    'thr.range': '推荐范围',
    'thr.action': '操作',

    // SQL Audit
    'audit.all': '全部',
    'audit.pending': '待处理',
    'audit.processing': '处理中',
    'audit.fixed': '已修复',
    'audit.whitelisted': '白名单',
    'audit.id': 'ID',
    'audit.severity': '严重级别',
    'audit.type': '类型',
    'audit.target': '目标',
    'audit.foundTime': '发现时间',
    'audit.status': '状态',
    'audit.actions': '操作',
    'audit.optimize': '优化',
    'audit.modalTitle': 'SQL 优化诊断',
    'audit.issueId': '问题 ID',
    'audit.targetSql': '目标 SQL',
    'audit.diagnosis': '诊断分析',
    'audit.recommendation': '优化建议',
    'audit.apply': '应用修复',
    'audit.whitelist': '加入白名单',
    'audit.cancel': '取消',

    // Audit Log
    'log.allOps': '所有操作',
    'log.updateThr': '更新阈值',
    'log.export': '导出',
    'log.time': '时间',
    'log.user': '用户',
    'log.op': '操作类型',
    'log.target': '对象',
    'log.result': '结果',

    // Visualizer
    'vis.title': '执行计划可视化',
    'vis.import': '导入',
    'vis.view': '视图',
    'vis.costThreshold': '成本阈值',
    'vis.explain': '执行分析',
    'vis.help': '帮助',
    'vis.sqlEditor': 'SQL 编辑器',
    'vis.syntax': 'GaussDB 语法',
    'vis.pastePlaceholder': '在此粘贴您的 SQL...',
    'vis.planText': '计划文本',
    'vis.rawExplain': '原始 Explain',
    'vis.noPlan': '未生成计划',
    'vis.visualTree': '可视化树',
    'vis.totalCost': '总成本',
    'vis.analyzing': '正在分析执行计划...',
    'vis.selectSql': '选择 SQL 以查看计划',
    'vis.node.cost': '成本',
    'vis.node.rows': '行数',
    'vis.node.width': '宽度',
    'vis.node.target': '目标对象',
    'vis.node.details': '详情',
    'vis.opt.suggestions': '优化建议',
    'vis.opt.highCost': '检测到高成本连接',
    'vis.opt.highCostDesc': '根节点的哈希连接成本为 {cost}，超过了阈值。请检查连接列是否已建立索引。',
    'vis.opt.indexOpp': '索引建议',
    'vis.opt.indexOppDesc': '对 \'users\' 表进行顺序扫描。建议创建索引。',
    'vis.opt.loadToSee': '加载计划以查看建议',
    'vis.hot.title': 'WDR Top SQL',
    'vis.hot.viewFull': '查看完整报告',
    'vis.hot.preview': 'SQL 预览',
    'vis.hot.time': '耗时',
    'vis.hot.cost': '成本',
    'vis.hot.action': '操作',
    'vis.hot.load': '加载',

    // Visualizer Help Guide
    'vis.guide.title': 'GaussDB 执行计划指南',
    'vis.guide.scans': '扫描方式',
    'vis.guide.joins': '连接方式',
    'vis.guide.others': '其他算子',
    'vis.guide.seqScan': '顺序扫描 (Seq Scan)',
    'vis.guide.seqScanDesc': '全表扫描。读取表中的每一行。对于小表或读取大部分数据时效率较高，但对于大表且过滤性强的查询，效率较低。',
    'vis.guide.indexScan': '索引扫描 (Index Scan)',
    'vis.guide.indexScanDesc': '使用索引查找特定行。对于选择性高的查询，比全表扫描快得多。',
    'vis.guide.bitmapScan': '位图扫描 (Bitmap Heap/Index Scan)',
    'vis.guide.bitmapScanDesc': '结合多个索引扫描，或高效处理大量非连续的行获取。',
    'vis.guide.nestLoop': '嵌套循环 (Nested Loop)',
    'vis.guide.nestLoopDesc': '通过遍历外表的每一行并在内表中查找匹配项来连接两个表。当外表较小或内表有索引时效率最高。',
    'vis.guide.hashJoin': '哈希连接 (Hash Join)',
    'vis.guide.hashJoinDesc': '将“内”表的候选行加载到哈希表中，然后扫描“外”表以探测匹配项。适用于大型、未排序的数据集。',
    'vis.guide.mergeJoin': '归并连接 (Merge Join)',
    'vis.guide.mergeJoinDesc': '连接两个已排序的数据集。如果输入数据已经排序（例如通过索引），则非常高效。',
    'vis.guide.agg': '聚合 (Hash/Group)',
    'vis.guide.aggDesc': 'GROUP BY 或 DISTINCT 等操作。HashAggregate 使用哈希表，而 GroupAggregate 需要输入已排序。',
  }
};

interface I18nContextProps {
  language: Language;
  setLanguage: (lang: Language) => void;
  t: (key: string, params?: Record<string, any>) => string;
}

const I18nContext = createContext<I18nContextProps | undefined>(undefined);

export const I18nProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [language, setLanguage] = useState<Language>(() => {
    return (localStorage.getItem('app_language') as Language) || 'zh';
  });

  useEffect(() => {
    localStorage.setItem('app_language', language);
  }, [language]);

  const t = (key: string, params?: Record<string, any>) => {
    let text = translations[language][key as keyof typeof translations['en']] || key;
    if (params) {
        Object.entries(params).forEach(([k, v]) => {
            text = text.replace(`{${k}}`, String(v));
        });
    }
    return text;
  };

  return (
    <I18nContext.Provider value={{ language, setLanguage, t }}>
      {children}
    </I18nContext.Provider>
  );
};

export const useI18n = () => {
  const context = useContext(I18nContext);
  if (!context) {
    throw new Error('useI18n must be used within an I18nProvider');
  }
  return context;
};
